define(["config","data","map","domReady","tpl","helpers","panels","happiness","minmax"],function(e,t,r,a,o,n,i,s,p){"use strict";var l="app:";a(function(r){$("#loader").addClass("done"),$.when(s,p,t.allresolved).done(function(t,r,a){for(var i={},s=Object.keys(t),p=0,d=s.length;d>p;p++)i[s[p]]=100-t[s[p]].Score/r.max*100;console.log(l+"shades",i);var c=L.geoJson(a.countries,{onEachFeature:function(t,s){t.properties.happiness=n.get_happiness(t.properties.name,a.happiness),t.properties.gdp=n.get_property(t.properties.name,a.gdp,"IntDollar"),t.properties.population=n.get_property(t.properties.name,a.population,"Population"),t.properties.area=n.get_property(t.properties.name,a.areas,"Land"),t.properties.center=n.get_properties(t.properties.name,a.centroids,["LAT","LONG"]),t.properties.ppa=0,t.properties.area>0&&(t.properties.population||(t.properties.population=0),t.properties.ppa=t.properties.population/t.properties.area),s.setStyle(e.defaultStyle),void 0!==i[t.properties.name]&&s.setStyle({fillColor:"hsl(66, 22%, "+(10*r.max-i[t.properties.name])+"%)"}),s.on("click",function(e){o.info_detail._container.innerHTML=o.info_detailTpl({name:this.feature.properties.name,happiness:t.properties.happiness,population:t.properties.population.formatNumber(),area:t.properties.area.formatNumber(),ppa:t.properties.ppa.toFixed(2),gdp:t.properties.gdp.formatNumber()}),o.info_panel._container.innerHTML=o.info_panelTpl({name:this.feature.properties.name}),c.eachLayer(function(e){c.resetStyle(e)});var r=e.target;r.setStyle({fillOpacity:.2}),L.DomUtil.removeClass(o.info_detail._container,"hidden")})}});e.overlayMaps["Happiness Score"]=c})})}),define(["leaflet"],function(e){"use strict";var t={maxZoom:17,minZoom:2,zoom_level:3,animate:!0,highlightStyle:{radius:2,fillColor:"#FFFFFF",color:"#FBF0FD",weight:1,opacity:.9,fillOpacity:0},defaultStyle:{radius:2,fillColor:"#888888",color:"#FBF0FD",weight:1,opacity:.9,fillOpacity:.8},gdp:{green:25}};return t.baseMaps={tiles:e.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:t.maxZoom,minZoom:t.minZoom,attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'})},t.overlayMaps={},t.remapping={"United States":"United States of America",Tanzania:"United Republic of Tanzania",Serbia:"Republic of Serbia"},t}),define(["jquery","domReady","helpers","papaparse"],function(e,t,r,a){"use strict";var o={};return o.data={},o.all=e.Deferred(),o.register=function(t){return o.data[t]=e.Deferred(),o.data[t]},o.resolve=function(e,t){o.data[e].resolve(t)},o.reject=function(e,t){o.data[e].reject("Could not load "+e+" data")},o.allresolved=function(){for(var e=Object.keys(o.data),t=!0,r=0,a=e.length;a>r;r++)if(!o.data[e[r]].isResolved()){t=!1;break}return t&&o.all.resolve(o.data),o.all},o}),Number.prototype.formatNumber=function(){var e=this;return e.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},String.prototype.formatNumber=function(){var e=this;return e.replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},define([],function(){"use strict";var e={};return e.load_csv=function(e,t){return void 0===t&&(t="text"),$.ajax({url:e,dataType:t}).fail(function(e){console.error(e)})},e.getLegendColor=function(e){return"hsl(66, 22%, "+10*e+"%)"},e.get_happiness=function(e,t){for(var r="unknown",a=0,o=t.length;o>a;a++)if(t[a].Country===e){r=t[a].Score;break}return r>=0||(r="unknown"),r},e.get_property=function(e,t,r){var a="unknown";return void 0===t[e]?(console.debug(r+":",e+" not found"),a):void 0===t[e][r]?(console.debug(r+":",r+" not found"),a):a=t[e][r]},e.get_properties=function(e,t,r){var a=[];if(void 0===t[e])return console.debug(r.join(",")+":",e+" not found"),a;for(var o=0,n=r.length;n>o;o++){if(void 0===t[e][r[o]])return console.debug(r.join(",")+":",r[o]+" not found"),a;a.push(t[e][r[o]])}return a},e}),define(["leaflet","map","config","happiness_layer","bordercrossings_layer","app"],function(e,t,r,a,o,n){"use strict";console.log("config.overlayMaps",r.overlayMaps);var i=e.control.layers(r.overlayMaps).addTo(t);return i.setPosition("bottomleft"),i});for(var data_plugins=["areas","centroids","conflicts","countries","gdp","population","happiness","bordercrossings"],config={baseUrl:"./",waitSeconds:0,urlArgs:"bust="+(new Date).getTime(),paths:{jquery:"./vendor/jquery/dist/jquery.min",domReady:"./vendor/domReady/domReady",text:"./vendor/text/text",leaflet:"./vendor/leaflet/dist/leaflet","mapbox-arc":"./vendor/mapbox/arc",papaparse:"vendor/papaparse/papaparse.min",bootstrap:"vendor/bootstrap/dist/js/bootstrap.min",doT:"vendor/doT/doT.min",config:"./js/config",tpl:"./js/tpl",helpers:"./js/helpers",data:"./js/data",map:"./js/map",panels:"./js/panels",minmax:"./js/minmax","mapbox-arc":"./js/mapbox-arc",app:"./js/app",happiness_layer:"./js/layers/happiness_layer",bordercrossings_layer:"./js/layers/bordercrossings_layer",migration:"./js/layers/migration",layerscontrol:"./js/layerscontrol"},shim:{app:["jquery","leaflet","papaparse"],arcs:["leaflet","mapbox-arc"],helpers:["jquery"],layerscontrol:["app"]}},keys=Object.keys(data_plugins),i=0,s=keys.length;s>i;i++)config.paths[data_plugins[keys[i]]]="./js/data/"+data_plugins[keys[i]];requirejs.config(config),requirejs(["app"]),requirejs(data_plugins),requirejs(["layerscontrol"]),define(["config","leaflet"],function(e,t){"use strict";var r=t.map("map",{center:t.latLng(47.5133586,10.1074008),zoom:e.zoom_level,animate:e.animate,layers:[e.baseMaps.tiles]});return r}),define([],function(){"use strict";var e=Math.PI/180,t=180/Math.PI,r=function(t,r){this.lon=t,this.lat=r,this.x=e*t,this.y=e*r};r.prototype.view=function(){return String(this.lon).slice(0,4)+","+String(this.lat).slice(0,4)},r.prototype.antipode=function(){var e=-1*this.lat,t=this.lon<0?180+this.lon:-1*(180-this.lon);return new r(t,e)};var a=function(){this.coords=[],this.length=0};a.prototype.move_to=function(e){this.length++,this.coords.push(e)};var o=function(e){this.properties=e||{},this.geometries=[]};o.prototype.json=function(){if(this.geometries.length<=0)return{geometry:{type:"LineString",coordinates:null},type:"Feature",properties:this.properties};if(1==this.geometries.length)return{geometry:{type:"LineString",coordinates:this.geometries[0].coords},type:"Feature",properties:this.properties};for(var e=[],t=0;t<this.geometries.length;t++)e.push(this.geometries[t].coords);return{geometry:{type:"MultiLineString",coordinates:e},type:"Feature",properties:this.properties}},o.prototype.wkt=function(){for(var e="",t="LINESTRING(",r=function(e){t+=e[0]+" "+e[1]+","},a=0;a<this.geometries.length;a++){if(0===this.geometries[a].coords.length)return"LINESTRING(empty)";var o=this.geometries[a].coords;o.forEach(r),e+=t.substring(0,t.length-1)+")"}return e};var n=function(e,t,a){if(!e||void 0===e.x||void 0===e.y)throw new Error("GreatCircle constructor expects two args: start and end objects with x and y properties");if(!t||void 0===t.x||void 0===t.y)throw new Error("GreatCircle constructor expects two args: start and end objects with x and y properties");this.start=new r(e.x,e.y),this.end=new r(t.x,t.y),this.properties=a||{};var o=this.start.x-this.end.x,n=this.start.y-this.end.y,i=Math.pow(Math.sin(n/2),2)+Math.cos(this.start.y)*Math.cos(this.end.y)*Math.pow(Math.sin(o/2),2);if(this.g=2*Math.asin(Math.sqrt(i)),this.g==Math.PI)throw new Error("it appears "+e.view()+" and "+t.view()+" are 'antipodal', e.g diametrically opposite, thus there is no single route but rather infinite");if(isNaN(this.g))throw new Error("could not calculate great circle between "+e+" and "+t)};n.prototype.interpolate=function(e){var r=Math.sin((1-e)*this.g)/Math.sin(this.g),a=Math.sin(e*this.g)/Math.sin(this.g),o=r*Math.cos(this.start.y)*Math.cos(this.start.x)+a*Math.cos(this.end.y)*Math.cos(this.end.x),n=r*Math.cos(this.start.y)*Math.sin(this.start.x)+a*Math.cos(this.end.y)*Math.sin(this.end.x),i=r*Math.sin(this.start.y)+a*Math.sin(this.end.y),s=t*Math.atan2(i,Math.sqrt(Math.pow(o,2)+Math.pow(n,2))),p=t*Math.atan2(n,o);return[p,s]},n.prototype.Arc=function(e,t){var r=[];if(!e||2>=e)r.push([this.start.lon,this.start.lat]),r.push([this.end.lon,this.end.lat]);else for(var n=1/(e-1),i=0;e>i;++i){var s=n*i,p=this.interpolate(s);r.push(p)}for(var l=!1,d=0,c=t&&t.offset?t.offset:10,u=180-c,h=-180+c,f=360-c,g=1;g<r.length;++g){var v=r[g-1][0],m=r[g][0],y=Math.abs(m-v);y>f&&(m>u&&h>v||v>u&&h>m)?l=!0:y>d&&(d=y)}var b=[];if(l&&c>d){var _=[];b.push(_);for(var j=0;j<r.length;++j){var w=parseFloat(r[j][0]);if(j>0&&Math.abs(w-r[j-1][0])>f){var M=parseFloat(r[j-1][0]),x=parseFloat(r[j-1][1]),T=parseFloat(r[j][0]),C=parseFloat(r[j][1]);if(M>-180&&h>M&&180==T&&j+1<r.length&&r[j-1][0]>-180&&r[j-1][0]<h){_.push([-180,r[j][1]]),j++,_.push([r[j][0],r[j][1]]);continue}if(M>u&&180>M&&-180==T&&j+1<r.length&&r[j-1][0]>u&&r[j-1][0]<180){_.push([180,r[j][1]]),j++,_.push([r[j][0],r[j][1]]);continue}if(h>M&&T>u){var S=M;M=T,T=S;var k=x;x=C,C=k}if(M>u&&h>T&&(T+=360),180>=M&&T>=180&&T>M){var L=(180-M)/(T-M),F=L*C+(1-L)*x;_.push([r[j-1][0]>u?180:-180,F]),_=[],_.push([r[j-1][0]>u?-180:180,F]),b.push(_)}else _=[],b.push(_);_.push([w,r[j][1]])}else _.push([r[j][0],r[j][1]])}}else{var D=[];b.push(D);for(var q=0;q<r.length;++q)D.push([r[q][0],r[q][1]])}for(var I=new o(this.properties),N=0;N<b.length;++N){var P=new a;I.geometries.push(P);for(var R=b[N],A=0;A<R.length;++A)P.move_to(R[A])}return I};var i={};return i.Coord=r,i.Arc=o,i.GreatCircle=n,i}),define(["happiness"],function(e){"use strict";var t=$.Deferred();return $.when(e).done(function(e){console.log("minmax:happiness",e);for(var r,a=0,o=Object.keys(e),n=0,i=o.length;i>n;n++)a=Math.max(a,e[o[n]].Score),r=r?Math.min(r,e[o[n]].Score):e[o[n]].Score;var s={min:r,max:a};t.resolve(s)}),t}),define(["jquery","tpl","leaflet","map","config","helpers","happiness","minmax"],function(e,t,r,a,o,n,i,s){"use strict";t.info_panel.onAdd=function(){var e=r.DomUtil.create("div","info panel");return e.innerHTML="Choose your origin",e},t.info_panel.addTo(a),t.info_detail.onAdd=function(){var e=r.DomUtil.create("div","info detail");return r.DomUtil.addClass(e,"hidden"),r.DomUtil.addClass(e,"pull-right"),r.DomUtil.addClass(e,"bottomright"),e.innerHTML=t.info_detailTpl({name:"Country"}),e},t.info_detail.addTo(a),e(".info.debug").parent("div").addClass("debug"),e.when(s).done(function(e){var t=r.control({position:"bottomright"});t.onAdd=function(t){var a=r.DomUtil.create("div","info legend"),i=Array.apply(null,Array(parseInt(e.max+1,10))).map(function(e,t){return t});a.innerHTML+='<div><i style="background:'+o.defaultStyle.fillColor+'"></i> ?</div>';for(var s=parseInt(e.min,10)+1,p=s;p<i.length;p++)a.innerHTML+='<div><i style="background:'+n.getLegendColor(i[p-s]+1)+'"></i> '+i[p]+(i[p+1]?"&ndash;"+i[p+1]:"+")+"</div>";return r.DomUtil.addClass(a,"pull-right"),r.DomUtil.addClass(a,"bottomright"),a},t.addTo(a)})}),define(["doT","leaflet"],function(e,t){"use strict";var r={};return r.tpl={},r.tpl.info_detail='<div class="info debug"><div>Happiness:  <span class="happiness">{{=it.happiness}}</span></div><div>Population: <span class="population">{{=it.population}}</span></div><div>Area (km<sup>2</sup>): <span class="area">{{=it.area}}</span></div><div>Population per km<sup>2</sup>: <span class="ppa">{{=it.ppa}}</span></div><div>GDP-PPP (Int$): <span class="gdp">{{=it.gdp}}</span></div></div>',r.info_detailTpl=e.template(r.tpl.info_detail),r.info_detail=t.control({position:"bottomright"}),r.tpl.info_panel='<div class="col-xs-12"><h2>{{=it.name}}</h2>Details here</div>',r.info_panelTpl=e.template(r.tpl.info_panel),r.info_panel=t.control({position:"topright"}),r}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("areas"),n=r.load_csv("data/area/countries-area.csv");return e.when(n).done(function(r){function o(e,t){r[c].hasOwnProperty(t)&&"string"==typeof r[c][t]&&(r[c][t]=r[c][t].replace(/\s*\([\d\.\,]+\)/g,""),r[c][t]=parseInt(r[c][t].replace(/,/g,""),10),d=l[t],r[c][d]=r[c][t],delete r[c][t])}if(!r)return void n.reject("Could not load area data");r=a.parse(r,{delimiter:",",newline:"",header:!0,dynamicTyping:!0}),r=r.data;var i,s={},p=["Land in km2 (mi2)","Total in km2 (mi2)","Water in km2 (mi2)"],l={"Land in km2 (mi2)":"Land","Total in km2 (mi2)":"Total","Water in km2 (mi2)":"Water"},d="",c=0;for(c=0,i=r.length;i>c;c+=1)e.each(p,o),s[r[c].Country]=r[c];console.log("areas",s),t.resolve("areas",s)}),o}),define(["data","helpers"],function(e,t){"use strict";var r=e.register("bordercrossings"),a=t.load_csv("data/bordercrossings/bordercrossings.geojson","json");return a.done(function(t){e.resolve("bordercrossings",t)}),r}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("centroids"),n=r.load_csv("data/country/country_centroids_all.csv");return e.when(n).done(function(r){if(!r)return void n.reject("Could not load countries");r=a.parse(r,{delimiter:"	",newline:"",header:!0,dynamicTyping:!0}),r=r.data;var o={};e.each(r,function(e,t){void 0!==t.SHORT_NAME&&(o[t.SHORT_NAME]=t)}),console.log("centroids",o),t.resolve("centroids",o)}),o}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("conflicts"),n=r.load_csv("data/war/war.csv");return e.when(n).done(function(e){if(!e)return void n.reject("Could not load war conflicts");var r=a.parse(e,{delimiter:",",newline:"",header:!0,dynamicTyping:!0});r=r.data,console.log("conflicts",r),t.resolve("conflicts",r)}),o}),define(["jquery","data","helpers"],function(e,t,r){"use strict";var a=t.register("countries"),o=r.load_csv("data/country/countries.geojson","json");return e.when(o).done(function(e){if(!e)return void o.reject("Could not load countries");var r=e.features;t.resolve("countries",r)}),a}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("gdp"),n=r.load_csv("data/gdp/gdp.csv");return e.when(n).done(function(r){if(!r)return void n.reject("Could not load gdp");r=a.parse(r,{delimiter:",",newline:"",header:!0,dynamicTyping:!0}),r=r.data;var o={};e.each(r,function(e,t){"string"==typeof t.IntDollar&&(t.IntDollar=parseInt(t.IntDollar.replace(/,/g,""),10)),o[t.Country]=t}),console.log("gdp",o),t.resolve("gdp",o)}),o}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("happiness"),n=r.load_csv("data/happiness/world-happiness-index.csv");return n.done(function(r){if(!r)return void o.reject("Could not load happiness data");r=a.parse(r,{delimiter:",",newline:"",header:!0,dynamicTyping:!0}),r=r.data;var n={};e.each(r,function(e,t){void 0!==t.Country&&(void 0!==t.Rank&&(t.Rank=parseInt(t.Rank,10)),void 0!==t.Score&&(t.Score=parseFloat(t.Score)),n[t.Country]=t)}),t.resolve("happiness",n)}),o}),define(["jquery","data","helpers","papaparse"],function(e,t,r,a){"use strict";var o=t.register("population"),n=r.load_csv("data/population/population.csv");return e.when(n).done(function(e){if(!e)return void o.reject("Could not load population data");e=a.parse(e,{delimiter:",",newline:"",header:!0,dynamicTyping:!0}),e=e.data;for(var r={},n=0,i=e.length;i>n;n++){for(var s in e[n])e[n].hasOwnProperty(s)&&"string"==typeof e[n][s]&&(e[n][s]=e[n][s].replace(/\s*\[Note\s\d+\]/g,"").replace(/\s*\*\([a-z,\.\-\s]+\)\*/gi,"").replace(/[\*\"]/g,""),"Population"===s&&(e[n][s]=parseInt(e[n][s].replace(/,/g,""),10)));r[e[n]["Country (or dependent territory)"]]=e[n]}console.log("population",r),t.resolve("population",r)}),o}),define(["config","bordercrossings","leaflet","helpers"],function(e,t,r,a){"use strict";$.when(t).done(function(t){var a=r.geoJson(t,{pointToLayer:function(e,t){return e.properties.radius=50,r.circle(t,e.properties.radius,{radius:10,color:"#ff0000",fillColor:"#ef8080"})},onEachFeature:function(e,t){t.bindPopup(e.properties.name)}});e.overlayMaps["Border Crossings"]=a})}),define(["config","countries","leaflet","helpers","papaparse","happiness"],function(e,t,r,a,o,n){"use strict";var i=a.geoJson(t,{style:e.defaultStyle,onEachFeature:function(e,t){e.properties.happiness=get_happiness(e.properties.name,r),e.properties.gdp=get_property(e.properties.name,gdp,"IntDollar"),e.properties.population=get_property(e.properties.name,population,"Population"),e.properties.area=get_property(e.properties.name,areas,"Land"),e.properties.ppa=0,e.properties.area>0&&(e.properties.population||(e.properties.population=0),e.properties.ppa=e.properties.population/e.properties.area)}});e.overlayMaps["Happiness Score"]=i}),define(["leaflet","domReady","map","mapbox-arc"],function(e,t,r,a){"use strict";t(function(t){var o={x:36.8027059,y:34.794319},n={x:-.3817789,y:51.528308},i=new a.GreatCircle(o,n,{name:"Syria migration 1"}),s=i.Arc(100,{offset:10}),o=(e.geoJson(s.json()).addTo(r),{x:36.8027059,y:34.794319}),n={x:5.9677381,y:51.0782036},i=new a.GreatCircle(o,n,{name:"Syria migration 1"}),s=i.Arc(100,{offset:10});e.geoJson(s.json()).addTo(r)})});