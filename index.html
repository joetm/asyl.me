<!DOCTYPE html>
<html>
<head>
	<title>Asyl.me</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="static/css/leaflet.css" />

	<link rel="stylesheet" href="static/css/screen.css" />
	<!--
	<link rel="stylesheet" href="static/css/MarkerCluster.css" />
	<link rel="stylesheet" href="static/css/MarkerCluster.Default.css" />
	-->

	<script src="static/js/leaflet.1.0.js"></script>
	<script src="static/js/leaflet.curve.js"></script>
	<script src="static/js/shp.min.js"></script>
	<script src="static/js/leaflet.shpfile.js"></script>

	<!--
	<script src="static/js/leaflet.markercluster-src.js"></script>
	-->

	<script src="static/js/jquery.min.js"></script>

	<link rel="shortcut icon" href="static/images/favicon.ico">

</head>
<body>

	<div id="progress"><div id="progress-bar"></div></div>

	<div id="header">

		<h1>Asyl-Statistik</h1>

	</div>

	<div id="map" style="height:100%;margin:0 auto;width:100%;"></div>

	<script type="text/javascript">

		// zoom level config
		// ----------
		var zoom_level = 3,
            minZoom = 2,
			maxZoom = 17;
		// ----------

		var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				maxZoom: maxZoom,
				minZoom: minZoom,
				attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			}),
			latlng = L.latLng(47.683, 14.912);

		var map = L.map('map', {
			center: latlng,
			zoom: zoom_level,
			layers: [tiles]
		});


		var AU = {
			lat: 47.683,
			lng: 14.912
		};

		/*
		//get the countries
		var countries;
		$.getJSON('data/country/country.json', function (data) {
			countries = data;
			$(document).trigger('asylme:countryloaded');
		});
		$(document).on('asylme:countryloaded', function() {
			var i = 0, s = countries.length;
			var factor;
			for (i = 0; i < s; i++) {
			}
		});
		*/


		$(document).ready(function(){

			var countries = [];

			try {

				var shpfile = new L.Shapefile('static/shape/TM_WORLD_BORDERS_SIMPL-0.3.zip', {
					onEachFeature: function(feature, layer) {
						//console.log('feature', feature);
						if (feature.properties) {
							if (['AT'].indexOf(feature.properties.ISO2) !== -1) {

								layer.bindPopup(Object.keys(feature.properties).map(function(k) {
									return k + ": " + feature.properties[k];
								}).join("<br />"), {
									maxHeight: 200
								});
								layer.setStyle({fillColor: '#FF0000', color: '#AA9999', weight: 3, fillOpacity: 0.8});

							} else if (['SY', 'AF', 'IQ', 'PK', 'IR', 'SO', 'RU', 'NG', 'DZ', 'BD', 'UA', 'MA', 'IN'].indexOf(feature.properties.ISO2) !== -1) {

								layer.bindPopup(Object.keys(feature.properties).map(function(k) {
									return k + ": " + feature.properties[k];
								}).join("<br />"), {
									maxHeight: 200
								});
								layer.setStyle({fillColor: '#404040', color: '#202020', weight: 3});

								countries.push(feature.properties);

							} else {

								try {
									layer.setStyle({fillColor: '#dddddd', color: '#333333', weight: 1, fillOpacity: 0.8});
									//map.removeLayer(feature);
									//feature.geometry.style.display = 'none';
								} catch (err) {}

							}
						}
					}
				});
				shpfile.addTo(map);
				shpfile.once("data:loaded", function() {
					console.log("finished loaded shapefile");
					//remove loading anim
					$('#map').css('background-image', 'none');

					var i = 0,
						s = countries.length,
						country;
					for (i = 0; i < s; i++) {
						country = countries[i];
						//add the path
						var factor_lat = Math.abs(country.LAT - AU.lat) / 3;
						var factor_lng = Math.abs(country['LON'] - AU.lng) / 3;
						if (country['LAT'] > AU.lat) {factor_lat = -1 * factor_lat;}
						if (country['LON'] < AU.lng) {factor_lng = -1 * factor_lng;}
						var path = L.curve([
								/*
									'M',[country['LAT'], country['LON']],
									'C',[country['LAT'] + , (AU.lng + 2*factor_lng) * 1.2],
										[AU.lat + factor_lat, (AU.lng + factor_lng) * 1.2],
										[AU.lat, AU.lng]
								*/
									'M',[country['LAT'], country['LON']],
									'C',[country['LAT'] + factor_lat, country['LON'] + factor_lng],
										[AU.lat + factor_lat, AU.lng + factor_lng],
										[AU.lat, AU.lng]
								],
								{color:'#44A6A2',zIndex:999999,fill:false,opacity:0.8}).addTo(map);
						try {
							path.bringToFront();
						} catch (err) {}
					}//end for

				});




			} catch (err) {
				console.log('Exception:', err);
			}

		});

	</script>
</body>
</html>
